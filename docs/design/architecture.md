# アーキテクチャ設計書

## システムアーキテクチャ

### 全体構成

```
┌─────────────────┐
│   Frontend      │
│  (Next.js)      │
└────────┬────────┘
         │
         │ HTTPS
         │
┌────────▼─────────────────────────────────────┐
│         API Gateway                            │
│  (Spring Cloud Gateway / AWS API Gateway)      │
└────────┬───────────────────────────────────────┘
         │
    ┌────┴────┬──────────┬──────────┬──────────┐
    │         │          │          │          │
┌───▼───┐ ┌──▼───┐ ┌────▼────┐ ┌───▼───┐ ┌───▼───┐
│ Auth  │ │Content│ │  Media  │ │ User  │ │  ...  │
│Service│ │Service│ │ Service │ │Service│ │       │
└───┬───┘ └───┬───┘ └────┬────┘ └───┬───┘ └───┬───┘
    │         │          │          │          │
┌───▼───┐ ┌──▼───┐ ┌────▼────┐ ┌───▼───┐
│Postgres│ │Postgres│ │   S3   │ │Postgres│
│(auth_db)│ │(content)│ │        │ │(user_db)│
└────────┘ └─────────┘ └────────┘ └─────────┘
```

## マイクロサービス設計

### 1. API Gateway Service

**責務**:
- 全APIリクエストの統合エンドポイント
- ルーティング
- 認証・認可の統一管理
- レート制限
- ログ集約

**技術スタック**:
- Spring Cloud Gateway
- AWS API Gateway (本番環境)

**デプロイ方式**:
- 開発: Spring Cloud Gateway (Fargate)
- 本番: AWS API Gateway + Lambda

### 2. Auth Service

**責務**:
- ユーザー認証
- JWTトークン発行・検証
- リフレッシュトークン管理
- パスワード管理

**データベース**:
- PostgreSQL (auth_db)

**デプロイ方式**:
- Lambda

### 3. Content Service

**責務**:
- コンテンツのCRUD操作
- バージョン管理
- 公開・非公開管理
- コンテンツ検索

**データベース**:
- PostgreSQL (content_db)

**デプロイ方式**:
- Lambda / Fargate (用途に応じて選択)

### 4. Media Service

**責務**:
- メディアファイルのアップロード
- 画像処理・リサイズ
- S3連携
- メディアメタデータ管理

**ストレージ**:
- AWS S3

**データベース**:
- PostgreSQL (media_db) - メタデータ用

**デプロイ方式**:
- Lambda / Fargate

### 5. User Service

**責務**:
- ユーザー情報のCRUD操作
- プロフィール管理
- 権限管理
- ユーザー検索

**データベース**:
- PostgreSQL (user_db)

**デプロイ方式**:
- Lambda

## データベース設計

### データベース分離戦略

各マイクロサービスは独立したPostgreSQLデータベースを持つ：

- `auth_db`: 認証情報、トークン
- `content_db`: コンテンツデータ
- `media_db`: メディアメタデータ
- `user_db`: ユーザー情報

### データ整合性

- イベント駆動アーキテクチャ（将来実装）
- 分散トランザクションは避ける
- 最終整合性を許容

## セキュリティ設計

### 認証・認可

- JWTベースの認証
- API Gatewayでトークン検証
- 各サービスで権限チェック

### ネットワークセキュリティ

- VPC内にデプロイ（本番環境）
- セキュリティグループでアクセス制御
- HTTPS通信の強制

## スケーラビリティ

### Lambda

- 自動スケーリング
- 同時実行数の制限設定
- プロビジョンドコンテナ（コールドスタート対策）

### Fargate

- オートスケーリング設定
- CPU/メモリの最適化

## モニタリング・ロギング

- CloudWatch Logs: 各サービスのログ
- CloudWatch Metrics: パフォーマンスメトリクス
- X-Ray: 分散トレーシング（オプション）
- アラート設定

## デプロイメント戦略

### 開発環境

- Docker Composeでローカル実行
- 各サービスを個別に起動可能

### ステージング環境

- Lambda関数としてデプロイ
- 本番環境と同様の構成

### 本番環境

- Lambda: 軽量なサービス
- Fargate: 長時間実行が必要なサービス
- API Gateway: AWS API Gatewayを使用



